
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com\jkk111\indigo\services\index.go (81.5%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package services

import (
  "runtime"
  "os/exec"
  "sync"
  "os"
  "io"
  "fmt"
  "regexp"
  "reflect"
  path "path/filepath"
  "github.com/jkk111/indigo/util"
  "github.com/jkk111/indigo/logger"
  "github.com/jkk111/indigo/database"
  "github.com/jkk111/indigo/git"
  Proxy "github.com/jkk111/indigo/proxy"
)

var GlobalRunningProcesses = make(map[string]*ActiveService)
var RunHistory = make(map[string]int64)
var RunningMutex = sync.Mutex{}
var RunCountMutex = sync.Mutex{}

type ActiveService struct {
  id string
  cmd * exec.Cmd
}

func must_pipe(p io.ReadCloser, err error) io.ReadCloser <span class="cov8" title="1">{
  if err != nil </span><span class="cov0" title="0">{
    panic(err)</span>
  }

  <span class="cov8" title="1">return p</span>
}

func InstallService(service * database.Service, hash string) <span class="cov8" title="1">{
  dir := util.Path(path.Join("repos", hash))

  cmd := exec.Command(service.Install, service.InstallArgs...)

  cmd_env := append(os.Environ(), service.InstallEnv...)
  cmd.Env = cmd_env
  cmd.Dir = dir

  stdout := must_pipe(cmd.StdoutPipe())
  stderr := must_pipe(cmd.StderrPipe())

  logger.CreateLogInstance(service.Name + "-install", stdout, stderr)
  err := cmd.Run()

  if err != nil </span><span class="cov0" title="0">{
    fmt.Println(err)
    panic(err)</span>
  }
}

func NewActiveService(service_id string, commit string, start []string, env []string) * ActiveService <span class="cov8" title="1">{
  fmt.Println("Running", start[0], start[1:])
  cmd := exec.Command(start[0], start[1:]...)
  re := regexp.MustCompile(`\${datadir}`)
  datadir := util.DataDir()
  for i, v := range env </span><span class="cov8" title="1">{
    env[i] = re.ReplaceAllString(v, datadir)
  }</span>

  <span class="cov8" title="1">cmd_env := append(os.Environ(), env...)

  cmd.Env = cmd_env
  cmd.Dir = util.Path(path.Join("repos", commit))

  svc := &amp;ActiveService{ 
    id: util.RandomId(),
    cmd: cmd,
  }

  stdout, err := cmd.StdoutPipe()

  if err != nil </span><span class="cov0" title="0">{
    panic(err)</span>
  }

  <span class="cov8" title="1">stderr, err := cmd.StderrPipe()

  if err != nil </span><span class="cov0" title="0">{
    panic(err)</span>
  }

  <span class="cov8" title="1">logger.CreateLogInstance(service_id, stdout, stderr)
  RunningMutex.Lock()
  GlobalRunningProcesses[svc.id] = svc
  RunningMutex.Unlock()
  var start_err error
  start_err = cmd.Start()
  go func() </span><span class="cov8" title="1">{
    if start_err == nil </span><span class="cov8" title="1">{
      err := cmd.Wait()
      if err != nil </span><span class="cov0" title="0">{
        fmt.Println(reflect.TypeOf(err))
        fmt.Println(err)
      }</span> else<span class="cov0" title="0"> {
        RunningMutex.Lock()
        delete(GlobalRunningProcesses, svc.id)
        RunningMutex.Unlock()
      }</span>
    }
  }()
  <span class="cov8" title="1">return svc</span>
}

func (this * ActiveService) Kill() <span class="cov8" title="1">{
  if runtime.GOOS == "windows" </span><span class="cov8" title="1">{
    this.cmd.Process.Kill()
  }</span> else<span class="cov0" title="0"> {
    this.cmd.Process.Signal(os.Interrupt)
  }</span>
}

func Close() <span class="cov8" title="1">{
  for _, svc := range GlobalRunningProcesses </span><span class="cov8" title="1">{
    svc.Kill()
  }</span>
}

func Load() <span class="cov8" title="1">{
  services := database.Services()
  proxy := Proxy.Instance()
  for _, service := range services </span><span class="cov8" title="1">{
    env := service.Env
    instance_no := RunHistory[service.Name]
    RunCountMutex.Lock()
    RunHistory[service.Name]++
    RunCountMutex.Unlock()
    ln_port := util.GetSocket(service.Name, int(instance_no))
    port := fmt.Sprintf("socket=%s", ln_port)
    env = append(env, port)

    params := make([]string, len(service.Args) + 1)
    params[0] = service.Start
    copy(params[1:], service.Args)

    branch := service.Branch
    branches := git.LsRemote(service.Repo)

    if branches == nil </span><span class="cov8" title="1">{
      continue</span>
    }

    <span class="cov8" title="1">var b * git.Branch

    if branches[branch] == nil </span><span class="cov0" title="0">{
      b = branches["master"]
    }</span> else<span class="cov8" title="1"> {
      b = branches[branch]
    }</span>

    <span class="cov8" title="1">if !util.Exists(util.Path(path.Join("repos", b.Hash))) </span><span class="cov0" title="0">{
      b.Clone()
      InstallService(service, b.Hash)
    }</span>

    <span class="cov8" title="1">service.LatestHash = b.Hash

    NewActiveService(service.Name, service.LatestHash, params, env)
    proxy.AddRoute(service.Host, service.Path, ln_port, true)</span>
  }
}

func New(service * database.Service) <span class="cov0" title="0">{
  git.LsRemote(service.Repo)
}</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
